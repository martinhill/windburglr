<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WindBurglr - {{ station }}</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
        <link rel="stylesheet" href="/static/style.css" />
    </head>
    <body>
        <div class="container">
            <header>
                <div class="header-content-outer">
                    <div class="header-content">
                        <div class="title-section">
                            {% if is_live %}
                            <span class="station"
                                >{{ station }} currently:</span
                            >
                            {% else %}
                            <span class="station"
                                >{{ station }} on
                                <span id="formatted-date"
                                    >{{ selected_date }}</span
                                ></span
                            >
                            {% endif %}
                        </div>
                        {% if is_live %}
                        <div class="current-conditions-compact">
                            <div class="condition-compact">
                                <span class="value" id="current-speed">--</span>
                                <span class="label">kts</span>
                            </div>
                            <div class="condition-compact">
                                <span class="value" id="current-direction"
                                    >--</span
                                >
                            </div>
                            <div class="condition-compact">
                                <span class="value" id="current-gust">--</span>
                                <span class="label">gust</span>
                            </div>
                            <div class="condition-compact">
                                <span class="value" id="last-update">--</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div
                        class="connection-indicator"
                        id="connection-status"
                        title="Connecting..."
                    ></div>
                </div>
            </header>

            <div class="charts-container">
                <div class="chart-section">
                    <!-- <h3>Wind Speed & Direction (Last {{ hours }} hours)</h3> -->
                    <canvas id="windChart"></canvas>
                </div>
            </div>

            <div class="controls">
                {% if is_live %}
                <button id="toggle-realtime" class="btn">
                    Pause Real-time Updates
                </button>
                <select id="time-range">
                    <option value="1">Last 1 hour</option>
                    <option value="3" selected>Last 3 hours</option>
                    <option value="6">Last 6 hours</option>
                    <option value="12">Last 12 hours</option>
                    <option value="24">Last 24 hours</option>
                </select>
                <button id="view-yesterday" class="btn">View Yesterday</button>
                {% else %}
                <div class="date-navigation">
                    <button
                        id="prev-date"
                        class="btn"
                        onclick="navigateToDate('{{ prev_date }}')"
                    >
                        ← Previous Day
                    </button>
                    <input
                        type="date"
                        id="date-picker"
                        value="{{ selected_date }}"
                        onchange="navigateToDate(this.value)"
                    />
                    <button
                        id="next-date"
                        class="btn"
                        onclick="navigateToDate('{{ next_date }}')"
                    >
                        Next Day →
                    </button>
                    <a href="/" class="btn">Back to Live</a>
                </div>
                {% endif %}
            </div>
        </div>

        <script>
                const STATION = '{{ station }}';
                const IS_LIVE = {{ is_live|lower }};
                const DIRECTIONS = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                {% if not is_live %}
                const DATE_START = '{{ date_start }}';
                const DATE_END = '{{ date_end }}';
                {% endif %}

                let windChart;
                let websocket;
                let realtimeEnabled = true;
                let windData = [];

                function navigateToDate(date) {
                    const currentParams = new URLSearchParams(window.location.search);
                    const stn = currentParams.get('stn') || '{{ station }}';
                    window.location.href = `/date/${date}?stn=${stn}`;
                }

                function getDirectionText(degrees) {
                    if (degrees === null || degrees === undefined) return '--';
                    const index = Math.round(degrees / 22.5) % 16;
                    return DIRECTIONS[index];
                }

                function formatTime(timestamp) {
                    return new Date(timestamp * 1000).toLocaleTimeString();
                }

                function formatDateTime(timestamp) {
                    return new Date(timestamp * 1000).toLocaleString();
                }

                function updateCurrentConditions(data) {
                    document.getElementById('current-speed').textContent = data.speed_kts || '--';
                    document.getElementById('current-direction').textContent = getDirectionText(data.direction);
                    document.getElementById('current-gust').textContent = data.gust_kts || '--';
                    document.getElementById('last-update').textContent = formatTime(data.timestamp);
                }

                function initCharts() {
                    const ctx = document.getElementById('windChart').getContext('2d');

                    windChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Wind Speed (kts)',
                                data: [],
                                borderColor: 'rgb(0, 168, 240)',
                                backgroundColor: 'rgba(0, 168, 240, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            }, {
                                label: 'Gust (kts)',
                                data: [],
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1,
                                fill: false,
                                yAxisID: 'y'
                            }, {
                                label: 'Wind Direction',
                                data: [],
                                borderColor: 'orange',
                                // backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                pointBackgroundColor: 'orange',
                                fill: false,
                                yAxisID: 'y1',
                                showLine: false,
                                pointStyle: 'circle'
                            }]
                        },
                        options: {
                            pointStyle: false,
                            responsive: true,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute',
                                        stepSize: 15,
                                        displayFormats: {
                                            minute: 'HH:mm'
                                        },
                                        tooltipFormat: 'MMM dd, HH:mm'
                                    },
                                    ticks: {
                                        maxTicksLimit: 20,
                                        autoSkip: true,
                                        source: 'data'
                                    }
                                    //     unit: 'hour',
                                    //     displayFormats: {
                                    //       hour: 'HH:mm'
                                    //     }
                                    // },
                                    // ticks: {
                                    //   stepSize: 0.25,
                                    //
                                    // }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Speed (knots)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    min: 0,
                                    max: 360,
                                    title: {
                                        display: true,
                                        text: 'Direction'
                                    },
                                    ticks: {
                                        stepSize: 45,
                                        callback: function(value) {
                                            return getDirectionText(value);
                                        }
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            },
                            plugins: {
                                legend: {
                                    // display: true,
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: function(context) {
                                            if (context.datasetIndex === 2) { // Direction dataset
                                                return `(${getDirectionText(context.parsed.y)})`;
                                            }
                                            return '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

            function updateCharts(data) {
                const timeData = data.map(d => new Date(d[0] * 1000));
                const speeds = data.map(d => d[2]);
                const gusts = data.map(d => d[3]);
                const directions = data.map(d => d[1]).map(d => d === null ? null : d);

                windChart.data.labels = timeData;
                windChart.data.datasets[0].data = speeds;
                windChart.data.datasets[1].data = gusts;
                windChart.data.datasets[2].data = directions;
                windChart.update();
            }
                async function loadHistoricalData(hours = 3) {
                    try {
                        let url;
                        if (IS_LIVE) {
                            url = `/api/wind?stn=${STATION}&hours=${hours}`;
                        } else {
                            // For date view, use specific date range
                            url = `/api/wind?stn=${STATION}&from_time=${DATE_START}&to_time=${DATE_END}`;
                        }
                        const response = await fetch(url);
                        const data = await response.json();
                        windData = data.winddata;
                        updateCharts(windData);
                    } catch (error) {
                        console.error('Error loading historical data:', error);
                    }
                }

                function updateConnectionStatus(status, text) {
                    const statusElement = document.getElementById('connection-status');
                    statusElement.title = text;
                    statusElement.className = `connection-indicator ${status}`;
                    console.log(`WebSocket status: ${text}`);
                }

                function connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/${STATION}`;

                    updateConnectionStatus('connecting', 'Connecting...');

                    websocket = new WebSocket(wsUrl);

                    websocket.onopen = function(event) {
                        console.log('WebSocket connected successfully');
                        updateConnectionStatus('connected', 'Connected');
                    };

                    websocket.onmessage = function(event) {
                        console.log('WebSocket message received:', event.data);

                        try {
                            const data = JSON.parse(event.data);

                            // Handle ping messages
                            if (data.type === 'ping') {
                                console.log('Received ping from server');
                                updateConnectionStatus('connected', 'Connected');
                                return;
                            }

                            // Update status to show we're receiving data
                            updateConnectionStatus('connected', 'Connected (Live)');

                            if (!realtimeEnabled) return;

                            // Handle wind data messages
                            if (data.timestamp !== undefined) {
                                updateCurrentConditions(data);

                                // Add new data point to charts
                                const newPoint = [data.timestamp, data.direction, data.speed_kts, data.gust_kts];
                                console.log('New wind data point:', newPoint);
                                windData.push(newPoint);

                                // Keep only recent data (last 1000 points)
                                if (windData.length > 1000) {
                                    windData = windData.slice(-1000);
                                }

                                updateCharts(windData);
                            } else {
                                console.log('Received unknown message type:', data);
                            }
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    websocket.onclose = function(event) {
                        console.log('WebSocket closed:', event.code, event.reason);
                        updateConnectionStatus('disconnected', 'Disconnected');

                        // Attempt to reconnect after 5 seconds
                        setTimeout(() => {
                            console.log('Attempting to reconnect...');
                            connectWebSocket();
                        }, 5000);
                    };

                    websocket.onerror = function(error) {
                        console.error('WebSocket error:', error);
                        updateConnectionStatus('error', 'Connection Error');
                    };
                }

                // Function to get yesterday's date in YYYY-MM-DD format
                function getYesterdayDate() {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    return yesterday.toISOString().split('T')[0]; // Format as YYYY-MM-DD
                }

                // Event listeners
                {% if is_live %}
                document.getElementById('toggle-realtime').addEventListener('click', function() {
                    realtimeEnabled = !realtimeEnabled;
                    this.textContent = realtimeEnabled ? 'Pause Real-time Updates' : 'Resume Real-time Updates';
                    this.className = realtimeEnabled ? 'btn' : 'btn paused';
                });

                document.getElementById('view-yesterday').addEventListener('click', function() {
                    const yesterdayDate = getYesterdayDate();
                    navigateToDate(yesterdayDate);
                });
                {% endif %}

                {% if is_live %}
                document.getElementById('time-range').addEventListener('change', function() {
                    const hours = parseInt(this.value);
                    {% if is_live %}
                    loadHistoricalData(hours);
                    {% else %}
                    // For date view, navigate to same date with new hours parameter
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('hours', hours);
                    window.location.search = currentParams.toString();
                    {% endif %}
                });
                {% endif %}

                // Initialize the application
                document.addEventListener('DOMContentLoaded', function() {
                    {% if not is_live %}
                    // Format the selected date with weekday
                    const dateElement = document.getElementById('formatted-date');
                    if (dateElement) {
                        const date = new Date('{{ selected_date }}');
                        const options = {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        };
                        dateElement.textContent = date.toLocaleDateString('en-US', options);
                    }
                    {% endif %}

                    initCharts();
                    loadHistoricalData({{ hours }});
                    {% if is_live %}
                    connectWebSocket();
                    {% endif %}
                });
        </script>
    </body>
</html>
